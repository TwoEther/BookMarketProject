<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<link rel="stylesheet" href="/static/css/register.css">
<style>
    .container {
        display: flex;
        justify-content: center;
    }

</style>


<script>
    function emailDuplicateCheck(){
        var token = $("meta[name='_csrf']").attr("content");
	    var header = $("meta[name='_csrf_header']").attr("content");

        if (regexValidation() == true){
            validationDivOn();
            var email = document.getElementById("email").value;

            $.ajax({
                type: "POST",
                url: "/member/new/email-check",
                beforeSend : function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                data : {"email": email},
                success: function () {
                    alert("인증번호가 발송되었습니다");
                },
                error:function(request, status, error){
                    alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error); }
            });
        }
        else{
            alert("이메일이 올바르지 않습니다");
        }

    }

    function validationDivOn(){
        var con = document.getElementById("email_check_div");
        if (con.style.display=='none'){
            con.style.display = 'block';
        }
    }

    function regexValidation(){
        let regex = new RegExp('[a-z0-9]+@[a-z]+\.[a-z]{2,3}');
        var email = document.getElementById("email").value;
        if (regex.test(email) == false) return false;
        else return true;
    }

    function checkDuplicateId(){
        var token = $("meta[name='_csrf']").attr("content");
	    var header = $("meta[name='_csrf_header']").attr("content");

        var userId = document.getElementById("userId").value;
        var idChk = document.getElementById("idChk");
        $.ajax({
            type : "POST",
            url : "/member/idCheck",
            beforeSend : function(xhr){
				xhr.setRequestHeader(header, token);
            },
            data : {"userId" : userId},
            success : function(result) {
                console.log('통신 성공 ' + result);
                if (result == 'EMPTY'){
                    idChk.innerHTML = "아이디를 입력해주세요.";
                } else if (result == 'Reqex'){
                    idChk.innerHTML = "6자 이상 20자 이하의 영문, 숫자를 입력해주세요.";
                }else if (result == 'Dup'){
                    idChk.innerHTML = "이미 존재하는 아이디 입니다";
                }else {
                    idChk.innerHTML = "사용가능한 아이디 입니다";
                }
            },
            error : function(request, status, error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
    }

</script>

<body>

<div class="container" style="margin-top:30px;">
    <form role="form" id="loginForm" th:action="@{/member/new}" th:object="${memberForm}"
          method="post">
        <h4>회원가입</h4>
        <hr>
        <div class="form-group">
            <label th:for="id">아이디</label>
            <input type="hidden" th:name="${_csrf.parameterName}"
                      th:value="${_csrf.token}" />
            <input type="text" th:field="*{userId}" id="userId" class="form-control"
                   placeholder="아이디을 입력하세요" onkeyup="checkDuplicateId()"
                   th:class="${#fields.hasErrors('userId')}? 'form-control
    fieldError' : 'form-control'">
            <p id="idChk"></p>
            <p th:if="${#fields.hasErrors('userId')}"
               th:errors="*{userId}">Incorrect date</p>
    <!--            <a type="button" class = "btn btn-secondary" id="idck" onclick="idCheck()">중복체크</a>-->
    <!--            <button type="submit"  th:href="@{/member/emailCheck}" class="btn btn-primary">중복체크</button>-->
        </div>

        <div class="form-group">
            <label th:for="password">비밀번호</label>
            <input type="hidden" th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
            <input type="password" th:field="*{password1}" class="form-control"
                   placeholder="비밀번호를 입력하세요" id="pw1"
                   th:class="${#fields.hasErrors('password1')}? 'form-control
fieldError' : 'form-control'">
            <p th:if="${#fields.hasErrors('password1')}"
               th:errors="*{password1}">Incorrect date</p>
        </div>
        <div class="pw">
            <p>비밀번호는 8자에서 16자 사이의 특수 문자를 1개 이상 포함해야 합니다.</p>
        </div>

        <div class="form-group">
            <label th:for="name">이름</label>
            <input type="hidden" th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
            <input type="text" th:field="*{name}" class="form-control"
                   placeholder="이름을 입력하세요" id="name"
                   th:class="${#fields.hasErrors('name')}? 'form-control
    fieldError' : 'form-control'">
            <p th:if="${#fields.hasErrors('name')}"
               th:errors="*{name}">Incorrect date</p>
        </div>

        <div class="form-group">
            <label th:for="phoneNum">핸드폰번호</label>
            <input type="hidden" th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
            <input type="tel" th:field="*{phoneNum}" class="form-control"
                   placeholder="핸드폰 번호를 입력해 주세요" id="phoneNum"
                   th:class="${#fields.hasErrors('phoneNum')}? 'form-control
    fieldError' : 'form-control'">
            <p th:if="${#fields.hasErrors('phoneNum')}"
               th:errors="*{phoneNum}">Incorrect date</p>
        </div>

        <div class="form-group">
            <label th:for="email">이메일</label>
            <input type="hidden" th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
                <input type="email" th:field="*{email}" class="form-control"
                       placeholder="이메일을 입력해 주세요" id="email"
                       th:class="${#fields.hasErrors('email')}? 'form-control
        fieldError' : 'form-control'">
                <p th:if="${#fields.hasErrors('email')}"
                   th:errors="*{email}">Incorrect date</p>
                <input type="button" onclick="emailDuplicateCheck()" class="btn btn-secondary" value="인증하기">

        </div>

        <div class="form-group" id="email_check_div" style="display:none;">
            <input type="hidden" th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
            <input type="text" th:field="*{email_Check_number}"  placeholder="인증번호를 입력하세요">
        </div>

<!--        <div>-->
<!--            <div th:each="role : ${roles}" class="form-check form-check-inline">-->
<!--                <input type="radio" th:field="*{roles}" th:value="${role.name()}" class="form-check-input">-->
<!--                <label th:for="${#ids.prev('roles')}" th:text="${role.getDescription()}" class="form-check-label"></label>-->
<!--            </div>-->
<!--        </div>-->
        <div class="form_footer">
            <button type="submit" class="btn btn-primary" id="join_submit">Submit</button>
            <a href="/member/login" style="float:right;">이미 계정이 존재하신다면 클릭해주세요.</a>
        </div>
    </form>
        <br/>
    </div> <!-- /container -->
</body>
</html>