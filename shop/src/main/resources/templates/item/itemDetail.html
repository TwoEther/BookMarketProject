<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="fragments/header :: header" />
<link rel="stylesheet" href="/static/css/detail.css">
<style>
    a {
        text-decoration : none;
    }
</style>
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"/>
    <div class="row align-items-center" id="header_top" style="margin-top:10px; margin-bottom:10px;">
        <div style="float:right; display:inline;">
            <form class="d-flex" th:action="@{/item}" th:object="${form}">
                <input class="form-control me-2" type="search" name="keyword" placeholder="검색어를 입력하세요" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
        </div>
        <div class="col-3">
        </div>
    </div>
    <div class="container" style="margin-top: 50px;">
        <div class="categoryArea">
            <h3 style="display:inline;"><a href="" th:text="${item.getCategory().getCategory1()}"></a><span>>></span></h3>
            <h3 style="display:inline;"><a th:href="@{/item}" th:text="${item.getCategory().getCategory2()}"></a></h3>
            <h4 style="display:inline; float:right; text-align:right;"><a th:href="@{/item}">뒤로가기</a></h4>
        </div><hr>
        <div class="bookNameArea">
            <h1 style="text-align: center;" th:text="${item.name}"></h1>
            <h4 style="text-align: center;" th:text="${item.description}"></h4>
        </div><hr>
        <div class="mainArea">
            <div class="row">
                <div class="col-6">
                    <img th:src="@{${item.getFilePath()}}" alt="" width="90%" height="">
                </div>
                <div class="col-6" id="itemArea">
                    <div class="itemName">
                        <p>저자 : <span th:text="${item.author}"></span></p>
                    </div>

                    <div class="itemPublisher">
                        <p>출판사 : <span th:text="${item.publisher}"></span></p>
                    </div>

                    <div class="itemPage">
                        <p><span th:text="${item.pages}"></span>p</p>
                    </div>

                    <div th:if="${item.getStockQuantity()} <= 0 ">
                        <h3 style="color:red;">재고가 없습니다.</h3>
                    </div>
                    <div th:unless="${item.getStockQuantity()} <= 0 ">
                        <div class="" style="margin-bottom: 10px;">
                            <div class="row">
                                <div class="col-5">
                                    <span class="price">가격 : <span id="priceText" th:text="${item.price}">0</span>원</span>
                                </div>

                                <div class="col-7 ">
                                        <span class="countBox">
                                            <button id="leftbtn" onclick="leftBtnClicked()"><span>-</span>
                                            </button>
                                            <input type="number" value="1" id="quantityBlock">
                                            <span id="itemPrice" style="display:none;" th:text="${item.price}"></span>
                                            <button id="rightbtn" onclick="rightBtnClicked()">
                                                <span>+</span>
                                            </button>
                                        </span>
                                </div>
                                <script th:inline="javascript">
                                    function leftBtnClicked(){
                                        var result = document.getElementById('quantityBlock').value;
                                        result--;
                                        if(result < 0) result = 0;
                                        document.getElementById('quantityBlock').value = result;
                                        setPriceInHTML();
                                    }

                                    function rightBtnClicked(){
                                        var result = document.getElementById('quantityBlock').value;
                                        result++;
                                        document.getElementById('quantityBlock').value = result;
                                        setPriceInHTML();
                                    }

                                    function setPriceInHTML(){
                                        var price = "[[${item.price}]]";
                                        var count = document.getElementById('quantityBlock').value;
                                        result = price * count;
                                        document.getElementById('priceText').innerHTML = result;
                                    }


                                </script>
                            </div>

                        </div>
                        <form method="post" enctype="multipart/form-data" style="display:inline;">
                            <input class="btn btn-lg btn-primary" type="button" style="margin-right: 10px;"  onclick="quantityCheck()" sec:authorize="isAuthenticated()" value="장바구니 담기" readonly></input>
                        </form>
                            <script th:inline="javascript">
                            function quantityCheck(){
                                var stock = document.getElementById('quantityBlock').value;
                                var token = $("meta[name='_csrf']").attr("content");
                                var header = $("meta[name='_csrf_header']").attr("content");
                                const data = {"quantity" : stock,
                                            "itemId" : [[${item.id}]]};
                                $(function() {
                                    $(document).ajaxSend(function(e, xhr, options) {
                                        xhr.setRequestHeader(header, token);
                                    });
                                });
                                $.ajax({
                                    url : "/cart/add",
                                    type : "POST",
                                    dataType : "JSON",
                                    data : data,
                                    beforeSend: function (xhr) {
                                      xhr.setRequestHeader(header, token);
                                    },
                                    success : function(flag){
                                        if(flag == true){
                                            alert("장바구니에 담겼습니다");
                                            location.reload();
                                        }else{
                                            alert("알 수 없는 이유로 실패했습니다");
                                            location.reload();
                                        }
                                    },
                                    error:function(request,status,error){
                                    alert("code = "+ request.status + " message = " + request.responseText + " error = " + error); // 실패 시 처리
                                   }
                                });
                            }
                        </script>
                        <a class="btn btn-lg btn-primary" th:href="@{/member/login}" style="float:right;">구매하기</a>
                    </div>
                </div>
            </div>


        </div>
        <hr>
        <div class="similarArea">
            <h2>유사한 검색결과</h2>
            <div class ="row">
                <div class="col-2" th:each="item : ${groupItem}">
                    <div class="imageArea" >
                        <a th:href="@{/item/{param1}(param1=${item.id})}"><img th:src="@{${item.getFilePath()}}" alt=""  style="width:100px;"></a>
                        <p th:text="${item.getName()}"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="reviewArea">
            <h2>리뷰</h2>
            <form action="">
                <textarea id="reviewText"></textarea>
            </form>
        </div>
    </div>
        <div th:replace="fragments/footer :: footer"/>
    </div> <!-- /container -->
</body>
</html>