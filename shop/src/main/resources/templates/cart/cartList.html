<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<link rel="stylesheet" href="/static/css/detail.css">
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"/>

    <div class="container" >
        <table class="table">
            <thead>
            <tr>
                <th scope="col-1"><input type="checkbox"></th>
                <th scope="col-1"><span>상품 이미지</span></th>
                <th scope="col-4">상품정보</th>
                <th scope="col-5">금액</th>
                <th scope="col-1">삭제</th>
            </tr>
            </thead>

            <tbody th:each="cartItem : ${cartItems}">
            <tr>
                <th scope="row" style="margin-right: 20px;"><input type="checkbox"></th>
                <td><a th:href="@{/item/{param1}(param1=${cartItem.item.id})}"><img th:src="@{${cartItem.item.getFilePath()}}" alt="" width="100px"></a></td>
                <td><div>
                    <a href="" th:text="${cartItem.item.name}"></a>
                </div>
                    <div>
                        <p th:text="${cartItem.item.description}"></p>
                    </div>
                </td>
                <td>
                    <div><p th:text="${cartItem.item.price}" style="margin-bottom:0px;">원</p>
                        <span class="countBox">
                            <button th:id="${cartItem.id}" onclick="leftBtnClicked(this.id)"><span>-</span></button>
                            <input type="number" th:value="${cartItem.count}" th:id="'count'+${cartItem.id}" onclick="clicked(this.id)" class="input_btn">
                            <span id="itemPrice" style="display:none;" th:text="${cartItem.count}"></span>
                            <button id="rightbtn" onclick="rightBtnClicked()">
                                <span>+</span>
                            </button>
                            <script th:inline="javascript">
                            function leftBtnClicked(id){
                                var token = $("meta[name='_csrf']").attr("content");
                                var header = $("meta[name='_csrf_header']").attr("content");

                                var newId = '#'+'count'+ id;
                                let result = Number($newId).val());
                                console.log("result = "+result);
                                result--;
                                if(result < 0) result = 0;
                                $(newId).val(result);


                                $(function() {
                                    $(document).ajaxSend(function(e, xhr, options) {
                                        xhr.setRequestHeader(header, token);
                                    });
                                });
                                $.ajax({
                                    url : "/cart/edit/"+id,
                                    type : "PUT",
                                    dataType : "JSON",
                                    data : {"quantity" : value,
                                            "cartItemId" : id
                                    },
                                    beforeSend: function (xhr) {
                                      xhr.setRequestHeader(header, token);
                                    },
                                    success : function(){
                                        alert("실행에 성공했습니다");
                                        location.reload();
                                    },
                                    error:function(request,status,error){
                                    alert("code = "+ request.status + " message = " + request.responseText + " error = " + error); // 실패 시 처리
                                   }
                                });
                            }
                        }

                        </script>
                        </span>
                    </div>
                </td>
                <th scope="row" style="margin-right: 20px;">
                    <input th:onclick="cart_delete([[${cartItem.id}]])" type="button" value="X">
                </th>
                <script th:inline="javascript">
                    var token = $("meta[name='_csrf']").attr("content");
                    var header = $("meta[name='_csrf_header']").attr("content");
                    $(function() {
                        $(document).ajaxSend(function(e, xhr, options) {
                            xhr.setRequestHeader(header, token);
                        });
                    });

                    function cart_delete(id){
                        var newId = (id).toString();
                        $.ajax({
                            url : "/cart/delete/"+newId,
                            type : "DELETE",
                            data : {"cartItemId" : newId
                            },
                            beforeSend: function (xhr) {
                                      xhr.setRequestHeader(header, token);
                                    },

                            success : function(){
                                alert("삭제 되었습니다");
                                location.reload();
                            },
                            error:function(request,status,error){
                            alert("code = "+ request.status + " message = " + request.responseText + " error = " + error); // 실패 시 처리
                           }
                        });
                    }
                </script>
            </tr>


            </tbody>
        </table>
    </div>

    <div th:replace="fragments/footer :: footer"/>
</div> <!-- /container -->
</body>
</html>